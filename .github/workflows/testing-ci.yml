name: CI (testing branch) â€” Backend Tests

on:
  push:
    branches: [ testing ]
    paths:
      - "backend/**"
      - ".github/workflows/**"
      - "terraform/**"
      - "k8s/**"

permissions:
  contents: read

jobs:

  # Job 2: Provision infrastructure with Terraform
  terraform_apply:
    environment: Testing
    runs-on: ubuntu-latest
    # needs: test_backends   # only run if tests succeed

    permissions:
      id-token: write
      contents: read

    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.7   # match your local version

      # Azure login with OIDC
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Terraform Init
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # Import existing resources (if any)
      - name: Terraform Import Existing Resources (if needed)
        working-directory: terraform
        run: |
          set -e
          TFVARS="-var-file=environments/staging.tfvars"
          SUBS=${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RG=sit722akstagerg
          PREFIX=sit722akstage

          # Import Resource Group if exists
          if az group show -n $RG >/dev/null 2>&1; then
            terraform import $TFVARS azurerm_resource_group.rg /subscriptions/$SUBS/resourceGroups/$RG || true
          fi

          # Import ACR if exists
          if az acr show -n ${PREFIX}acr >/dev/null 2>&1; then
            terraform import $TFVARS azurerm_container_registry.acr /subscriptions/$SUBS/resourceGroups/$RG/providers/Microsoft.ContainerRegistry/registries/${PREFIX}acr || true
          fi

          # Import AKS if exists
          if az aks show -n ${PREFIX}aks -g $RG >/dev/null 2>&1; then
            terraform import $TFVARS azurerm_kubernetes_cluster.aks /subscriptions/$SUBS/resourceGroups/$RG/providers/Microsoft.ContainerService/managedClusters/${PREFIX}aks || true
          fi

          # Import Storage Account if exists
          if az storage account show -n ${PREFIX}storage -g $RG >/dev/null 2>&1; then
            terraform import $TFVARS azurerm_storage_account.storage /subscriptions/$SUBS/resourceGroups/$RG/providers/Microsoft.Storage/storageAccounts/${PREFIX}storage || true
          fi

          # Import Storage Container if exists
          if az storage container show --account-name ${PREFIX}storage --name images >/dev/null 2>&1; then
            terraform import $TFVARS azurerm_storage_container.images /subscriptions/$SUBS/resourceGroups/$RG/providers/Microsoft.Storage/storageAccounts/${PREFIX}storage/blobServices/default/containers/images || true
          fi

          # Import ACR Pull Role Assignment if exists
          ROLE_ID=$(az role assignment list \
            --scope "/subscriptions/$SUBS/resourceGroups/$RG/providers/Microsoft.ContainerRegistry/registries/${PREFIX}acr" \
            --role "AcrPull" \
            --query "[0].id" -o tsv || true)

          if [ -n "$ROLE_ID" ]; then
            terraform import $TFVARS azurerm_role_assignment.acr_pull $ROLE_ID || true
          fi

      # Terraform Apply (auto-approve)
      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve -var-file="environments/staging.tfvars"

      # Export outputs for later jobs (like storage account name & key, ACR server)
      - name: Capture Terraform Outputs
        id: tf_outputs
        working-directory: terraform
        run: |
          acr_server=$(terraform output -raw acr_login_server)
          echo "acr_server=$acr_server" >> $GITHUB_OUTPUT
          # Extract just the registry name before the first dot
          acr_name=$(echo $acr_server | cut -d. -f1)
          echo "acr_name=$acr_name" >> $GITHUB_OUTPUT
          echo "storage_account_name=$(terraform output -raw storage_account_name)" >> $GITHUB_OUTPUT
          echo "storage_account_key=$(terraform output -raw storage_account_key)" >> $GITHUB_OUTPUT
          echo "aks_rg=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "aks_name=$(terraform output -raw aks_name)" >> $GITHUB_OUTPUT

    outputs:
      acr_server: ${{ steps.tf_outputs.outputs.acr_server }}
      acr_name: ${{ steps.tf_outputs.outputs.acr_name }}
      storage_account_name: ${{ steps.tf_outputs.outputs.storage_account_name }}
      storage_account_key: ${{ steps.tf_outputs.outputs.storage_account_key }}
      aks_rg: ${{ steps.tf_outputs.outputs.aks_rg }}
      aks_name: ${{ steps.tf_outputs.outputs.aks_name }}

  # Job 3: Build & Push Images to ACR
  build_and_push_images:
    environment: Testing
    runs-on: ubuntu-latest
    needs: terraform_apply   # only run if infra is ready

    permissions:
      id-token: write
      contents: read

    env:
      IMAGE_TAG: ${{ github.sha }}
      ACR_SERVER: ${{ needs.terraform_apply.outputs.acr_server }}
      ACR_NAME: ${{ needs.terraform_apply.outputs.acr_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login to Azure (OIDC)
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Login to ACR
      - name: ACR login
        run: az acr login --name "$ACR_NAME"

      # Build and push Product Service
      - name: Build & Push product_service
        run: |
          docker build -t $ACR_SERVER/product_service:$IMAGE_TAG ./backend/product_service
          docker tag  $ACR_SERVER/product_service:$IMAGE_TAG $ACR_SERVER/product_service:staging-latest
          docker push $ACR_SERVER/product_service:$IMAGE_TAG
          docker push $ACR_SERVER/product_service:staging-latest

      # Build and push Order Service
      - name: Build & Push order_service
        run: |
          docker build -t $ACR_SERVER/order_service:$IMAGE_TAG ./backend/order_service
          docker tag  $ACR_SERVER/order_service:$IMAGE_TAG $ACR_SERVER/order_service:staging-latest
          docker push $ACR_SERVER/order_service:$IMAGE_TAG
          docker push $ACR_SERVER/order_service:staging-latest

      # Build and push Customer Service
      - name: Build & Push customer_service
        run: |
          docker build -t $ACR_SERVER/customer_service:$IMAGE_TAG ./backend/customer_service
          docker tag  $ACR_SERVER/customer_service:$IMAGE_TAG $ACR_SERVER/customer_service:staging-latest
          docker push $ACR_SERVER/customer_service:$IMAGE_TAG
          docker push $ACR_SERVER/customer_service:staging-latest

      # Build and push Frontend
      - name: Build & Push frontend
        run: |
          docker build -t $ACR_SERVER/frontend:$IMAGE_TAG ./frontend
          docker tag  $ACR_SERVER/frontend:$IMAGE_TAG $ACR_SERVER/frontend:staging-latest
          docker push $ACR_SERVER/frontend:$IMAGE_TAG
          docker push $ACR_SERVER/frontend:staging-latest
